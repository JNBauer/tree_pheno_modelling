---
bibliography: libs/references.bib
link-citations: TRUE
output: 
  html_document
---

## Lesson 11: Generating temperature scenarios

**1. For the location you chose for your earlier analyses, use chillR’s weather generator to produce 100 years of synthetic temperature data.**
```{r Loading and adjusting needed data, echo=FALSE}
require(chillR)
require(ggplot2)
fixed_weather <- read.csv("data/CapeTown_weather.csv")
weather_CapeTown <- fixed_weather
```

```{r Using the temperature_generation to create weather scenarios, eval=FALSE}
generated_temp<-temperature_generation(weather_CapeTown,
                             years=c(1990,2005),
                             sim_years = c(2001,2100))
```

```{r Saving the generated weather, eval=FALSE, echo=FALSE}
write.csv(generated_temp, "data/generated_temp.csv", row.names=FALSE)
```


```{r Loading and transforming data from weather generation, echo=FALSE}
generated_temp <- read.csv("data/generated_temp.csv")

temperatures<-cbind(weather_CapeTown[
  which(weather_CapeTown$Year %in% 1990:2005),], Data_source="observed")

temperatures<-rbind(temperatures[,c("Year","Month","Day","Tmin","Tmax","Data_source")],
                    cbind(generated_temp[,c("Year","Month","Day","Tmin","Tmax")],
                          Data_source="simulated"))

temperatures[,"Date"]<-as.Date(ISOdate(2000,
                                       temperatures$Month,
                                       temperatures$Day))
```


```{r Plotting generated weather with ggplot and geom_smooth}
ggplot(data=temperatures, aes(Date,Tmin)) +
  geom_smooth(aes(colour = factor(Year))) +
  facet_wrap(vars(Data_source)) +
  theme_bw(base_size = 20) +
  theme(legend.position = "none") +
  scale_x_date(date_labels = "%b")
```


**2. Calculate winter chill (in Chill Portions) for your synthetic weather, and illustrate your results as histograms and cumulative distributions.**

```{r Chill calc, message=FALSE}
chill_observed<-chilling(
  stack_hourly_temps(
    temperatures[which(temperatures$Data_source=="observed"),],
    latitude = -34.10835247406239),
  Start_JDay = 121, # Beginning May, start of "Winter" in southern hemisphere
  End_JDay = 243) # End of August, end of "Winter" in southern hemisphere

chill_simulated<-chilling(
  stack_hourly_temps(
    temperatures[which(temperatures$Data_source=="simulated"),],
    latitude = -34.10835247406239),
  Start_JDay = 121,
  End_JDay = 243)

chill_comparison <- cbind(chill_observed ,Data_source="observed") 
chill_simulated <- cbind(chill_simulated ,Data_source="simulated")

chill_comparison <- rbind(chill_comparison, chill_simulated) #stacking simulated
#and observed

chill_comparison_full_seasons<-chill_comparison[
  which(chill_comparison$Perc_complete==100),] #only including complete years

ggplot(chill_comparison_full_seasons, aes(x=Chill_portions)) + 
  geom_histogram(binwidth=1,aes(fill = factor(Data_source))) +
  theme_bw(base_size = 20) +
  labs(fill = "Data source") +
  xlab("Chill accumulation (Chill Portions)") +
  ylab("Frequency")
```

```{r Cumulative plotting of Chill portions}
chill_simulations<-chill_comparison_full_seasons[
  which(chill_comparison_full_seasons$Data_source=="simulated"),]

ggplot(chill_simulations, aes(x=Chill_portions)) +
  stat_ecdf(geom = "step",lwd=1.5,col="blue") +
  ylab("Cumulative probability") +
  xlab("Chill accumulation (in Chill Portions)") +
  theme_bw(base_size = 20)
```

**3. Produce similar plots for the number of freezing hours (<0°C) in April (or October, if your site is in the Southern Hemisphere) for your location of interest.**

```{r Calculating freezing hours with own steps model and tempResponse}
freezing_hours_steps <- data.frame(lower=c(-1000,0), 
                                   upper=c(0,1000),
                                   weight=c(1,0))

freezing_hours <- function(x) step_model(x,freezing_hours_steps)

CapeTown_temperature <- cbind(weather_CapeTown[
  which(weather_CapeTown$Year %in% 1990:2005),])

observed_temperature <- stack_hourly_temps(CapeTown_temperature[,c("Year","Month","Day","Tmin","Tmax")], latitude = -34.10835247406239)$hourtemps

simulated_temperature <- stack_hourly_temps(generated_temp[,c("Year","Month","Day","Tmin","Tmax")], latitude = -34.10835247406239)$hourtemps

freezing_observed <- tempResponse(make_JDay(observed_temperature),Start_JDay = 274,
                     End_JDay = 304,models=list(Freezing_Hours=freezing_hours))

freezing_simulated <- tempResponse(make_JDay(simulated_temperature),Start_JDay = 274,
                     End_JDay = 304,models=list(Freezing_Hours=freezing_hours))

freezing_comparison <- cbind(freezing_observed, Data_source="observed") 
freezing_simulated <- cbind(freezing_simulated, Data_source="simulated")


freezing_comparison <- rbind(freezing_comparison, freezing_simulated)

freezing_comparison_full_seasons<-freezing_comparison[
  which(freezing_comparison$Perc_complete==100),]

ggplot(freezing_comparison, aes(x=Freezing_Hours)) + 
  geom_histogram(binwidth=1,aes(fill = factor(Data_source))) +
  theme_bw(base_size = 20) +
  labs(fill = "Data source") +
  xlab("Freezing Hours") +
  ylab("Frequency")
```


```{r Cumulative plotting of Chill portions}
chill_simulations<-freezing_comparison_full_seasons[
  which(freezing_comparison_full_seasons$Data_source=="simulated"),]

chill_simulations

ggplot(chill_simulations, aes(x=Freezing_hours)) +
  stat_ecdf(geom = "step",lwd=1.5,col="blue") +
  ylab("Cumulative probability") +
  xlab("Chill accumulation (in Chill Portions)") +
  theme_bw(base_size = 20)
```